
steps:
  - checkout: self
  - task: AzureCLI@2
    displayName: 'Deploy ACR'
    inputs:
      azureSubscription: AzurePodcastConnection
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        $deploymentName = 'adobgtask$(Build.BuildNumber)'
        $resourceGroupName = '$(AZURE_RESOURCE_GROUP_NAME)'
        $acrName = '$(ACR_NAME)'
        
        az deployment group create -n "$($deploymentName)" `
            --resource-group  "$($resourceGroupName)" `
            --template-file deploy/Services/acr.bicep `
            --parameters acrName="$($acrName)"
  - task: Docker@2
    displayName: 'Login to ACR'
    inputs:
      command: 'login'
      containerRegistry: YKPodcastACRConnection
  - task: UseDotNet@2
    inputs:
      packageType: 'sdk'
      version: '7.0.x'
  - task: DotNetCoreCLI@2
    displayName: 'Build Podcast Updater'
    inputs:
      command: 'publish'
      publishWebProjects: false
      projects: 'src/Services/Podcasts/Podcast.Updater.Worker/Podcast.Updater.Worker.csproj'
      arguments: '-c Release -r linux-x64  /t:PublishContainer -o $(Build.ArtifactStagingDirectory) -p ContainerRegistry=$(ACR_NAME).azurecr.io -p ContainerImageTag=$(Build.BuildNumber)'
      zipAfterPublish: True